#include "lizard.h"
#include <stdio.h>
#include <ctime>
#include <math.h>
#include <stdlib.h>

float w0[] = {

    // white pawn

    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.100,  0.100,  0.100,  0.060,  0.060,  0.100,  0.100,  0.100,
    0.101,  0.102,  0.103,  0.090,  0.090,  0.003,  0.002,  0.001,
    0.102,  0.104,  0.106,  0.108,  0.108,  0.106,  0.104,  0.102,
    0.103,  0.106,  0.109,  0.112,  0.112,  0.109,  0.106,  0.103,
    0.104,  0.108,  0.112,  0.116,  0.116,  0.112,  0.108,  0.104,
    0.105,  0.110,  0.015,  0.120,  0.120,  0.115,  0.110,  0.105,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,

    // white knight

    0.288,  0.270,  0.290,  0.290,  0.290,  0.290,  0.270, 0.288,
    0.290,  0.300,  0.300,  0.300,  0.300,  0.300,  0.300, 0.290,
    0.290,  0.300,  0.305,  0.306,  0.306,  0.305,  0.300, 0.290,
    0.290,  0.300,  0.306,  0.312,  0.312,  0.306,  0.300, 0.290,
    0.290,  0.300,  0.306,  0.312,  0.312,  0.306,  0.300, 0.290,
    0.290,  0.300,  0.305,  0.306,  0.306,  0.305,  0.300, 0.290,
    0.290,  0.300,  0.300,  0.300,  0.300,  0.300,  0.300, 0.290,
    0.248,  0.290,  0.290,  0.290,  0.290,  0.290,  0.290, 0.248,

    // white bishop

    0.300,  0.300,  0.280,  0.300,  0.300,  0.280,  0.300,  0.300,
    0.300,  0.310,  0.310,  0.310,  0.310,  0.310,  0.310,  0.300,
    0.300,  0.310,  0.315,  0.316,  0.316,  0.315,  0.310,  0.300,
    0.300,  0.310,  0.316,  0.320,  0.320,  0.316,  0.310,  0.300,
    0.300,  0.310,  0.316,  0.320,  0.320,  0.316,  0.310,  0.300,
    0.300,  0.310,  0.315,  0.316,  0.316,  0.315,  0.310,  0.300,
    0.300,  0.310,  0.310,  0.310,  0.310,  0.310,  0.310,  0.300,
    0.300,  0.300,  0.300,  0.300,  0.300,  0.300,  0.300,  0.300,

    // white rook

    0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,
    0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,
    0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,
    0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,
    0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,
    0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,
    0.510,  0.510,  0.510,  0.510,  0.510,  0.510,  0.510,  0.510,
    0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,  0.500,

    // white queen

    0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,
    0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,
    0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,
    0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,
    0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,
    0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,
    0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,
    0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,  0.925,

    // white king

    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,

    // black pawn

    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
   -0.105, -0.110, -0.115, -0.120, -0.120, -0.115, -0.110, -0.105,
   -0.104, -0.108, -0.112, -0.116, -0.116, -0.112, -0.108, -0.104,
   -0.103, -0.106, -0.109, -0.112, -0.112, -0.109, -0.106, -0.103,
   -0.102, -0.104, -0.106, -0.108, -0.108, -0.106, -0.104, -0.102,
   -0.101, -0.102, -0.103, -0.090, -0.090, -0.103, -0.102, -0.101,
   -0.100, -0.100, -0.100, -0.060, -0.060, -0.100, -0.100, -0.100,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,

    // black knight

   -0.248, -0.290, -0.290, -0.290, -0.290, -0.290, -0.290, -0.248,
   -0.290, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.290,
   -0.290, -0.300, -0.305, -0.306, -0.306, -0.305, -0.300, -0.290,
   -0.290, -0.300, -0.306, -0.312, -0.312, -0.306, -0.300, -0.290,
   -0.290, -0.300, -0.306, -0.312, -0.312, -0.306, -0.300, -0.290,
   -0.290, -0.300, -0.305, -0.306, -0.306, -0.305, -0.300, -0.290,
   -0.290, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.290,
   -0.288, -0.270, -0.290, -0.290, -0.290, -0.290, -0.270, -0.288,

    // black bishop

   -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300,
   -0.300, -0.310, -0.310, -0.310, -0.310, -0.310, -0.310, -0.300,
   -0.300, -0.310, -0.315, -0.316, -0.316, -0.315, -0.310, -0.300,
   -0.300, -0.310, -0.316, -0.320, -0.320, -0.316, -0.310, -0.300,
   -0.300, -0.310, -0.316, -0.320, -0.320, -0.316, -0.310, -0.300,
   -0.300, -0.310, -0.315, -0.316, -0.316, -0.315, -0.310, -0.300,
   -0.300, -0.310, -0.310, -0.310, -0.310, -0.310, -0.310, -0.300,
   -0.300, -0.300, -0.280, -0.300, -0.300, -0.280, -0.300, -0.300,

   // black rook

   -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500,
   -0.510, -0.510, -0.510, -0.510, -0.510, -0.510, -0.510, -0.510,
   -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500,
   -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500,
   -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500,
   -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500,
   -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500,
   -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500, -0.500,

   // black queen

   -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925,
   -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925,
   -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925,
   -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925,
   -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925,
   -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925,
   -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925,
   -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925,

    // black king

    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,
    0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000,  0.000 };

float wHidden[] = { 1.00,       -1.00,  0.19207816550360182, -0.28545539328691016,  0.396588188150865 ,   0.24695236128807903, -0.5362844906950327,  -0.36544576791639924, 0.5858902293789134,  -4.983334886709058,    0.1159384389075866, -0.8235507819879793, -0.4827469992529991,  0.3952820198071656,   0.7431459595356849, -0.23778352844608216,  -0.06479,  0.32468, 0.8685,   0.035648, -0.03038,  0.6688, -0.16868, 0.2778, 0.18920, 0.15286, -0.16167, -0.34695, 0.32926, 0.16062, 0.33124, -0.11384, };
float wOutput[] = { 1000.00, -1000.00, -0.27438945931732184, -0.14496171160695885,  0.4059277750577273,  -0.23205661176809835,  0.18803239356195105, -0.2353651271910541,  0.12724667051168264, -2.8969126345149547, -0.34088263659032823, 0.62767366336512556, -0.23397834187873325, 0.11224404425735584, -0.36588433552593305, 0.638889601555899493, -0.73101, -0.14423, -0.17421, -0.16619, -0.015478, -0.2521,  0.8802, -0.4653, -0.29160, 0.695, -0.12231, 0.34263, -0.11271, 0.33463, 0.1867, 0.16960, };

void cNetwork::Init(int x) {

    finalWeight = 1.00;

    for (int i = 0; i < hiddenLayerSize; i++) {
        hiddenWeights[i] = wOutput[i];
        outputWeights[i] = wHidden[i];
    }

    LoadWeights("quantized.bin");
    
    //Reset();
};

void cNetwork::Reset() {

    // Initialize with small random values

    for (int i = 0; i < hiddenLayerSize; i++)
        for (int j = 0; j < 768; j++) {
            quantized[i][j] = GetXavierValue()*scaleFactor;
        }

    // Pre-initialize first two tables
    // (material weights and some centre tropism
    //  for minor pieces)

    for (int i = 0; i < 768; i++) {
        quantized[0][i] += w0[i] * scaleFactor;
        quantized[1][i] += w0[i] * scaleFactor;
    }

    SaveWeights("quantized.bin");
}

void cNetwork::PerturbWeight(int x) {

    // Generate a random index for the weight to perturb
    int i = rand() % hiddenLayerSize;
    int j = rand() % 768;
    if (j < 7 && j != 0) j = rand() % 768;

    // Generate a random sign for the perturbation
    int sign = (rand() % 2) ? 1 : -1;

    // Perturb the weight by x or -x
    quantized[i][j] += sign * x;
}

float cNetwork::GetXavierValue() {

    float mean = 0;
    float stddev = sqrt(1.0 / 768); // Xavier initialization
    return (float)rand() / RAND_MAX * 2 * stddev - stddev;
}

void cNetwork::SaveWeights(const char* filename) {
    FILE* file = fopen(filename, "wb");

    if (!file) {
        perror("Error opening file for writing");
        return;
    }

    // Write the number of weights to the file
    int numWeights = hiddenLayerSize * 768;
    fwrite(&numWeights, sizeof(numWeights), 1, file);

    // Write the weights to the file
    for (int i = 0; i < hiddenLayerSize; i++) {
        for (int j = 0; j < 768; j++) {
            fwrite(&quantized[i][j], sizeof(quantized[i][j]), 1, file);
        }
    }

    fclose(file);
}

void cNetwork::LoadWeights(const char* filename) {
    FILE* file = fopen(filename, "rb");

    int min = 32000;
    int max = -32000;

    if (!file) {
        perror("Error opening file for reading");
        return;
    }

    // Read the number of weights from the file
    int numWeights;
    fread(&numWeights, sizeof(numWeights), 1, file);

    // Check that the number of weights matches the expected value
    if (numWeights != hiddenLayerSize * 768) {
        fprintf(stderr, "Error: Invalid number of weights in file %s.\n", filename);
        return;
    }

    // Read the weights from the file
    for (int i = 0; i < hiddenLayerSize; i++) {
        for (int j = 0; j < 768; j++) {
            fread(&quantized[i][j], sizeof(quantized[i][j]), 1, file);
        }
    }

    fclose(file);
    //printf("min %d max %d", min, max);
}